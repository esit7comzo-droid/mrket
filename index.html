<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EPS Market - í†µí•©</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
/* ====== ê¸°ë³¸ ìŠ¤íƒ€ì¼ ====== */
body { font-family:'Segoe UI',sans-serif; margin:0; background:linear-gradient(120deg,#f0f0f0,#e0e0e0); }
header { background: linear-gradient(90deg,#4CAF50,#66BB6A); color:white; padding:2rem; text-align:center; font-size:2rem; letter-spacing:2px; box-shadow:0 4px 8px rgba(0,0,0,0.2);}
.container { max-width:1000px; margin:2rem auto; padding:1rem; display:none; }
input { padding:0.6rem; margin:0.5rem 0; border-radius:8px; border:2px solid #ccc; width:100%; transition:0.3s; }
input:focus { border-color:#4CAF50; box-shadow:0 0 6px #4CAF50; outline:none; }
button { padding:0.6rem 1.2rem; border:none; border-radius:12px; background:linear-gradient(90deg,#4CAF50,#66BB6A); color:white; font-weight:bold; cursor:pointer; transition:0.3s; margin:0.2rem; }
button:hover { background:linear-gradient(90deg,#66BB6A,#4CAF50); transform:scale(1.05); }
.product { background:white; padding:1rem; margin:1rem; display:inline-block; width:220px; text-align:center; border-radius:16px; box-shadow:0 4px 10px rgba(0,0,0,0.2); transition:0.3s;}
.product:hover { transform: translateY(-5px) scale(1.05); box-shadow:0 8px 20px rgba(0,0,0,0.3);}
.product img { width:100%; border-radius:12px; border:2px solid #4CAF50;}
.chat-container { border:2px solid #4CAF50; border-radius:16px; padding:1rem; max-height:400px; overflow-y:auto; margin-bottom:1rem; display:flex; flex-direction:column; }
.chat-message { padding:0.5rem 1rem; margin:0.3rem 0; border-radius:12px; max-width:70%; word-wrap:break-word; box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.chat-message.user { background:#4CAF50; color:white; align-self:flex-end;}
.chat-message.partner { background:#E0E0E0; color:#333; align-self:flex-start;}
.chat-input { display:flex; margin-bottom:1rem; }
.chat-input input { flex:1; padding:0.5rem; border-radius:8px; border:2px solid #ccc; margin-right:0.5rem;}
.chat-input input:focus { border-color:#4CAF50; box-shadow:0 0 6px #4CAF50; outline:none;}
h2,h3{margin:0.5rem 0;}
</style>
</head>
<body>

<header>ğŸ”¥ EPS Market í†µí•© ğŸ”¥</header>

<!-- ====== ë¡œê·¸ì¸ / íšŒì›ê°€ì… ====== -->
<div class="container" id="authContainer" style="display:block;">
  <h2>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
  <input type="email" id="email" placeholder="ì´ë©”ì¼">
  <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button id="signupBtn">íšŒì›ê°€ì…</button>
  <button id="loginBtn">ë¡œê·¸ì¸</button>
</div>

<!-- ====== ìŠ¤í† ì–´ ====== -->
<div class="container" id="storeContainer">
  <h3>ë‚´ ì½”ì¸: <span id="myCoin">0</span></h3>
  <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>

  <h2>ìƒí’ˆ ëª©ë¡</h2>
  <div id="products"></div>

  <h3>ìƒí’ˆ ì¶”ê°€</h3>
  <input type="text" id="productName" placeholder="ìƒí’ˆëª…">
  <input type="number" id="productPrice" placeholder="ê°€ê²©">
  <input type="text" id="productImage" placeholder="ì´ë¯¸ì§€ URL">
  <button id="addProductBtn">ì¶”ê°€</button>
</div>

<!-- ====== 1:1 Eí†¡ ====== -->
<div class="container" id="chatContainer">
  <div class="chat-container" id="chatMessages"></div>
  <div class="chat-input">
    <input type="text" id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥...">
    <button id="sendBtn">ì „ì†¡</button>
  </div>
  <button id="backToStoreBtn">ìŠ¤í† ì–´ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script>
// ====== Firebase ì„¤ì • ======
const firebaseConfig = {
  apiKey: "AIzaSyAus-wBYUVjjzGb1XnBhjKObDw2t_-C_98",
  authDomain: "eps-market.firebaseapp.com",
  projectId: "eps-market",
  storageBucket: "eps-market.firebasestorage.app",
  messagingSenderId: "974829100466",
  appId: "1:974829100466:web:98cf87f84f0b7100b818ab"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ====== ì „ì—­ ======
let currentUser = null;
let currentChatId = null;
let currentPartnerId = null;
let currentProductId = null;

// ====== ë¡œê·¸ì¸ / íšŒì›ê°€ì… ======
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  if(!email||!password) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
  const query = await db.collection("users").where("email","==",email).get();
  if(!query.empty) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼");
  const userRef = await db.collection("users").add({email,password,createdAt:new Date()});
  await db.collection("coin").doc(userRef.id).set({balance:10000});
  alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”");
});

document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const query = await db.collection("users").where("email","==",email).where("password","==",password).get();
  if(query.empty) return alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
  currentUser = {id: query.docs[0].id, email};
  document.getElementById("authContainer").style.display="none";
  document.getElementById("storeContainer").style.display="block";
  loadCoin();
  loadProducts();
});

// ====== ë¡œê·¸ì•„ì›ƒ ======
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  currentUser=null;
  document.getElementById("authContainer").style.display="block";
  document.getElementById("storeContainer").style.display="none";
});

// ====== ì½”ì¸ ë¶ˆëŸ¬ì˜¤ê¸° ======
async function loadCoin(){
  const doc = await db.collection("coin").doc(currentUser.id).get();
  document.getElementById("myCoin").textContent = doc.exists?doc.data().balance:0;
}

// ====== ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸° ======
async function loadProducts(){
  const productsDiv = document.getElementById("products");
  productsDiv.innerHTML="";
  const snapshot = await db.collection("products").get();
  snapshot.forEach(doc=>{
    const p = doc.data();
    const div = document.createElement("div");
    div.className="product";
    div.innerHTML=`
      <img src="${p.image}" alt="${p.name}">
      <h3>${p.name}</h3>
      <p>â‚©${p.price}</p>
      <button onclick="buyProduct('${doc.id}',${p.price},'${p.ownerId}')">êµ¬ë§¤ / Eí†¡</button>
    `;
    productsDiv.appendChild(div);
  });
}

// ====== ìƒí’ˆ ì¶”ê°€ ======
document.getElementById("addProductBtn").addEventListener("click", async ()=>{
  const name=document.getElementById("productName").value;
  const price=Number(document.getElementById("productPrice").value);
  const image=document.getElementById("productImage").value;
  if(!name||!price||!image) return alert("ëª¨ë“  í•­ëª© ì…ë ¥");
  await db.collection("products").add({name,price,image,ownerId:currentUser.id});
  loadProducts();
});

// ====== êµ¬ë§¤ + ì±„íŒ… ì´ë™ ======
async function buyProduct(productId,price,ownerId){
  if(ownerId===currentUser.id) return alert("ìê¸° ìƒí’ˆì€ êµ¬ë§¤ ë¶ˆê°€");
  const coinRef = db.collection("coin").doc(currentUser.id);
  const doc = await coinRef.get();
  const balance = doc.data()?.balance||0;
  if(balance<price) return alert("ì”ì•¡ ë¶€ì¡±");
  await coinRef.update({balance:balance-price});
  await db.collection("buy").add({userId:currentUser.id,productId,timestamp:new Date()});
  currentPartnerId=ownerId;
  currentProductId=productId;
  currentChatId=[currentUser.id,ownerId,productId].sort().join("_");
  openChat();
}

// ====== 1:1 ì±„íŒ… ======
async function openChat(){
  document.getElementById("storeContainer").style.display="none";
  document.getElementById("chatContainer").style.display="block";
  const chatRef = db.collection("chats").doc(currentChatId);
  const chatDoc = await chatRef.get();
  if(!chatDoc.exists) await chatRef.set({participants:[currentUser.id,currentPartnerId],productId:currentProductId,messages:[]});
  const chatContainer = document.getElementById("chatMessages");
  chatRef.onSnapshot(doc=>{
    chatContainer.innerHTML="";
    const msgs = doc.data().messages||[];
    msgs.forEach(msg=>{
      const div = document.createElement("div");
      div.className="chat-message "+(msg.sender===currentUser.id?"user":"partner");
      div.textContent = msg.text;
      chatContainer.appendChild(div);
      chatContainer.scrollTop=chatContainer.scrollHeight;
    });
  });
}

// ====== ì±„íŒ… ì „ì†¡ ======
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const input = document.getElementById("chatInput");
  const text = input.value.trim();
  if(!text) return;
  await db.collection("chats").doc(currentChatId).update({
    messages:firebase.firestore.FieldValue.arrayUnion({sender:currentUser.id,text,timestamp:new Date()})
  });
  input.value="";
});

// ====== ìŠ¤í† ì–´ë¡œ ëŒì•„ê°€ê¸° ======
document.getElementById("backToStoreBtn").addEventListener("click", ()=>{
  document.getElementById("chatContainer").style.display="none";
  document.getElementById("storeContainer").style.display="block";
});
</script>
</body>
  </html>
